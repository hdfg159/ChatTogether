<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>UserDetails</title>
    <th:block th:replace="template::generalAsset">
    </th:block>
    <script th:inline="javascript">
        function submitUserProfileForm() {
            $('#birthday').val(new Date(Date.parse($('#birthdaySource').val())));
            $('#userProfileForm').submit();
        }

        function addFriend(username) {
            $.getJSON('[(@{/userfriend/api/addfriend})]', {
                'username': username
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                alert('Add Friend Request Success!');
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function switchUserAccountState(id) {
            $.getJSON('[(@{/user/api/switchState})]', {
                'id': id
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                var switchState = $('#switchState');
                if (switchState.val() === 'Disable') {
                    switchState.val('Enable');
                    return;
                }
                switchState.val('Disable');
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function getObjectURL(file) {
            return window.URL.createObjectURL(file);
        }

        function inputProfilePhoto(cut_img) {
            var img_cropper = $('#img_cropper');
            img_cropper.attr('src', getObjectURL(cut_img.files[0]));
            crop(img_cropper);
            img_cropper.cropper('replace', getObjectURL(cut_img.files[0]));
        }

        function crop(img_cropper) {
            img_cropper.cropper({
                viewMode: 1,
                aspectRatio: 1,
                minCropBoxWidth: 100,
                minCropBoxHeight: 100,
                autoCropArea: 0.5,
                crop: function () {
                    var preview_img = $(this).cropper('getCroppedCanvas', {
                        width: 128,
                        height: 128,
                        minWidth: 128,
                        minHeight: 128,
                        maxWidth: 4096,
                        maxHeight: 4096,
                        fillColor: '#fff',
                        imageSmoothingEnabled: false,
                        imageSmoothingQuality: 'high'
                    }).toDataURL('image/jpg', 1);
                    $("#preview_img").attr("src", preview_img);
                }
            });
        }

        function uploadProfilePhoto() {
            var img_cropper = $('#img_cropper');
            img_cropper.cropper('getCroppedCanvas', {
                width: 128,
                height: 128,
                minWidth: 128,
                minHeight: 128,
                maxWidth: 4096,
                maxHeight: 4096,
                fillColor: '#fff',
                imageSmoothingEnabled: false,
                imageSmoothingQuality: 'high'
            }).toBlob(function (blob) {
                if (blob === null) {
                    alert('Error!Don\'t support this file!');
                    return;
                }
                var formData = new FormData();
                formData.append('[(${_csrf.parameterName})]', '[(${_csrf.token})]');
                formData.append('profilePhoto', blob);
                $.ajax('[(@{/userprofile/api/saveProfilePhoto})]', {
                    method: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data, textStatus, jqXHR) {
                        alert('保存成功');
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Request Error!' + errorThrown);
                    }
                });
            });
        }
    </script>
    <style>
        img {
            max-width: 100%;
        }
    </style>
</head>
<body>
<div th:replace="template::header"></div>
<h3>
    <span th:text="'UserDetails'"></span>
</h3>
<div id="tabs">
    <ul>
        <li>
            <a href="#tab_base">Basic Information</a>
        </li>
        <li>
            <a href="#tab_photo" th:if="${#authentication.name == userProfile.user.username}">Profile Photo</a>
        </li>
    </ul>
    <div id="tab_base">
        <img th:src="@{/{profilePhoto}(profilePhoto=${userProfile.user.userProfile.profilePhoto})}"
             th:width="48px"
             th:height="48px"/>
        <form th:id="'userProfileForm'" th:action="@{/userprofile/save}" th:method="post">
            <table th:unless="${userProfile == null}">
                <tr>
                    <td th:text="'UserId:'"></td>
                    <td th:text="${userProfile.user.id}"></td>
                    <td th:text="'Sex:'"></td>
                    <td>
                        <select th:name="'sex'" th:disabled="${#authentication.name!=userProfile.user.username}">
                            <option value="男" th:selected="${userProfile.sex == '男'}">男</option>
                            <option value="女" th:selected="${userProfile.sex == '女'}">女</option>
                        </select>
                    </td>
                    <td th:text="'Age:'"></td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}" th:name="'age'"
                               th:type="number" th:value="${userProfile.age}" value="年龄"
                               type="text"/>
                    </td>
                </tr>
                <tr>
                    <td th:text="'Username:'"></td>
                    <td th:text="${userProfile.user.username}"></td>
                    <td th:text="'QQ:'"></td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}" th:name="'qq'"
                               type="text" value="QQ" th:value="${userProfile.qq}"/>
                    </td>
                    <td th:text="'Birthday:'"></td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}" type="date"
                               th:id="'birthdaySource'"
                               th:value="${#dates.format(userProfile.birthday,'yyyy-MM-dd')}"/>
                        <input type="hidden" th:id="'birthday'" th:name="'birthday'"/>
                    </td>
                </tr>
                <tr>
                    <td th:text="'WeChat:'">
                    </td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}" name="wechat"
                               th:required="required" type="text"
                               th:value="${userProfile.wechat}"/>
                    </td>
                    <td th:text="'PhoneNumber:'"></td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}"
                               name="phoneNumber" type="text" maxlength="11" th:required="required"
                               th:value="${userProfile.phoneNumber}"/>
                    </td>
                    <td th:text="'CreateTime:'"></td>
                    <td th:text="${#dates.format(userProfile.createTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                <tr>
                    <td th:text="'Email:'"></td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}" th:name="'email'"
                               th:required="required" type="email"
                               th:value="${userProfile.email}"/>
                    </td>
                    <td th:text="'SelfIntroduction:'"></td>
                    <td>
                        <input th:disabled="${#authentication.name!=userProfile.user.username}"
                               th:name="'selfIntroduction'"
                               th:required="required" type="text"
                               th:value="${userProfile.selfIntroduction}"/>
                    </td>
                    <td th:text="'UpdateTime:'"></td>
                    <td th:text="${#dates.format(userProfile.modifiedTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                <tr>
                    <td th:if="${#authentication.name == userProfile.user.username}">
                        <input type="button" th:onclick="'submitUserProfileForm()'" value="save"></td>
                    <td>
                        <input type="hidden" th:name="id" th:value="${userProfile.id}">
                    </td>
                    <td th:if="${#authentication.name!=userProfile.user.username and !isExistUserFriend}">
                        <input type="button" th:onclick="'addFriend(\''+${userProfile.user.username}+'\');'"
                               th:value="'Add Friend'"/>
                    </td>
                    <td sec:authorize="hasAnyRole('ROLE_ADMIN_USER')"
                        th:if="${#authentication.name != userProfile.user.username}">
                        <input th:id="'switchState'" type="button"
                               th:onclick="'switchUserAccountState('+${userProfile.user.id}+');'"
                               th:value="${userProfile.user.getUserAccountState().getIsEnabled()==0?'Enable':'Disable'}"/>
                    </td>
                </tr>
            </table>
            <div th:unless="${error == null}">
                <span th:text=" ${error}"></span>
            </div>
        </form>
    </div>
    <div id="tab_photo" th:if="${#authentication.name == userProfile.user.username}">
        <input type="file" th:id="'cut_img'" onchange="inputProfilePhoto(this);" accept=".png,.jpg,.jpeg"/>
        <input type="button" th:value="'Upload Profile Photo'" onclick="uploadProfilePhoto();"/>
        <hr>
        <div th:text="'Preview Image:'"></div>
        <img th:id="'preview_img'">
        <hr>
        <img th:id="'img_cropper'"/>
    </div>
</div>
<div th:replace="template::footer"></div>
<script>
    $(function () {
        $("#tabs").tabs();
    });
</script>
<link rel="stylesheet" th:type="'text/css'" th:href="@{/webjars/cropper/3.1.3/dist/cropper.css}">
<script th:src="@{/webjars/cropper/3.1.3/dist/cropper.js}"></script>
</body>
</html>