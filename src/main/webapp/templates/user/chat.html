<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat With User</title>
    <script th:src="@{/webjars/sockjs-client/1.1.4/dist/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.4/lib/stomp.js}"></script>
    <th:block th:replace="template::editorAsset">
    </th:block>
    <script th:inline="javascript">
        var sock = new SockJS('[(@{/channel/chat})]');
        var stomp = Stomp.over(sock);

        stomp.connect('guest', 'guest', function (frame) {
            stomp.subscribe('/user/queue/chat', handleChatMessage);
        });

        function handleChatMessage(message) {
            if (message === null) {
                alert('发送消息失败！');
            }
            var msg = JSON.parse(message.body);
            if (msg.sendUsername === '[(${chatUsername})]') {
                addContent(msg);
                markMessageNotificationIsRead();
            }
            if (msg.sendUsername === '[(${#authentication.name})]') {
                $('.emojionearea-editor').html(' ');
                addContent(msg);
            }
        }

        function markMessageNotificationIsRead() {
            $.getJSON('[(@{/messagenotification/api/mark/users/msg/read(sendUsername=${chatUsername})})]', {}, function () {
            }).done(function (data, textStatus, jqXHR) {
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function addContent(msg) {
            var date = timeStampToString(msg.content.createTime);
            $('#head')
                .prepend("<div style='border: dotted;'>" + "<img src='[(@{/})]" + msg.content.sendUser.userProfile.profilePhoto + "' width='32px' height='32px'> <span>" + msg.sendUsername + "</span> <span>" + date + "</span><div>" + emojione.toImage(msg.content.content) + "</div>");
        }

        function sendChatMessage() {
            var chatMessageTextarea = $('#chatMessageTextarea');
            chatMessageTextarea.val(tranferStringLine(chatMessageTextarea.val()));
            var chatFormVO = $('#chatMessageForm').serializeObject();
            var text = JSON.stringify(chatFormVO);
            stomp.send('/app/chat', {}, text);
        }
    </script>
</head>
<body>
<div th:replace="template::header"></div>
<br/>
<form action="#" th:action="@{/}" th:method="get" th:id="'chatMessageForm'">
    <textarea id="chatMessageTextarea" name="content"></textarea>
    <input type="hidden" th:value="${chatUsername}" name="receiveUsername"/>
</form>
<input type="button" th:value="'Send'" onclick="sendChatMessage();"/>
<script type="text/javascript">
    $(document).ready(function () {
        $('#chatMessageTextarea').emojioneArea({
            placeholder: '请输入内容',
            buttonTitle: '按TAB键选择表情',
            pickerPosition: 'buttom',
            saveEmojisAs: 'shortname',
            recentEmojis: false,
            autocomplete: false,
            tonesStyle: 'square'
        });
    })
</script>
<div id="head"></div>
<th:block th:each="message:${messages}">
    <div style="border: dotted">
        <img th:src="@{/{profilePhoto}(profilePhoto=${message.sendUser.userProfile.profilePhoto})}"
             th:width="32px"
             th:height="32px"/>
        <span th:text="${message.sendUser.username}"></span>
        <span th:text="${#dates.format(message.createTime,'yyyy-MM-dd HH:mm:ss')}"></span>
        <div class="convert-emoji" th:utext="${message.content}"></div>
    </div>
</th:block>
<script th:inline="javascript">

</script>
<div>
    <form action="" th:action="@{/message/chat/{username}(username=${chatUsername})}" th:method="get"
          th:onsubmit="'return pageFormSubmit()'">
        <span th:text="|${messages.number+1}/${messages.totalPages}Pages|">总页数</span>
        <input type="number"
               th:min="1"
               th:max="${messages.totalPages}"
               th:id="input_page"
               th:required="required"/>
        <input type="hidden" th:name="page" th:id="submit_page"/>
        <input type="submit" th:value="Go">
    </form>
    <a th:unless="${messages.number == 0}"
       th:href="@{/message/chat/{username}(page=${messages.number - 1},username=${chatUsername})}"
       th:text="'Previous'">上一页</a>
    <a th:unless="${messages.number+1==messages.totalPages||messages.totalElements==0}"
       th:href="@{/message/chat/{username}(page=${messages.number+1},username=${chatUsername})}"
       th:text="'Next'">下一页</a>
    <span th:text="|${messages.numberOfElements}/${messages.totalElements} Element Counts|">页面显示数据量</span>
</div>
<div th:replace="template::footer"></div>
</body>
</html>