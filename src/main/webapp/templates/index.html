<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Chat Together</title>
    <th:block th:replace="template::editorAsset">
    </th:block>
    <script th:inline="javascript">
        function submitMicroWordForm() {
            var microWordContentSelector = $('#microWordContent');
            if (microWordContentSelector.val().length > 200) {
                alert('Data too long...');
                return;
            }
            microWordContentSelector.val(tranferStringLine(microWordContentSelector.val()));
            $.ajax('[(@{/microword/api/save})]', {
                method: "POST",
                data: new FormData($("#microWordForm")[0]),
                processData: false,
                contentType: false,
                success: function (data, textStatus, jqXHR) {
                    if (data.code === 0) {
                        alert(data.data);
                        return;
                    }
                    history.go(0);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert('保存失败!');
                }
            });
        }

        function deleteMicroWords() {
            $.post('[(@{/microword/api/deleteBatch})]', $('#microWordsForm').serialize(), function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(0);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function deleteMicroWord(microWordId) {
            $.post('[(@{/microword/api/delete})]', {
                'id': microWordId, _csrf: [[${_csrf.token}]]
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(0);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function agreeMicroWord(microWordId) {
            var microWordAgreeCountSelector = $('#microWordId_agree_' + microWordId);
            $.post('[(@{/microwordagree/api/save})]', {
                'microWordId': microWordId, _csrf: [[${_csrf.token}]]
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                microWordAgreeCountSelector.val(parseInt(microWordAgreeCountSelector.val()) + 1);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.info('Request Error!' + errorThrown);
                alert('您已经点赞过!不能再操作哦~');
            });
        }

        function uploadPicture(inputPicture) {
            var imgId = '#' + inputPicture.parentNode.id + '_img';
            var pictureName = $(inputPicture).val();
            var ext = pictureName.substring(pictureName.lastIndexOf("."), pictureName.length).toUpperCase();
            if (ext !== '.PNG' && ext !== '.JPG' && ext !== '.JPEG') {
                $(inputPicture).val('');
                $(imgId).html('');
                alert('不支持该文件格式');
                return;
            }
            if (inputPicture.files[0].size > 5 * 1024 * 1024) {
                $(inputPicture).val('');
                $(imgId).html('');
                alert('单个图片不能大于5MB');
                return;
            }
            $(imgId).html('<img width="256px" height="256px" src="' + getObjectURL(inputPicture.files[0]) + '" />');
        }

        function clearImg(button) {
            var fileId = '#' + button.parentNode.id;
            var imgId = '#' + button.parentNode.id + '_img';
            $(imgId).html('');
            $(fileId).find('input').val('');
        }
    </script>
</head>
<body>
<div th:replace="template::header"></div>
<div sec:authorize="isAuthenticated()" th:fragment="microWordForm">
    <h3 th:text="'Micro Word'">Theme</h3>
    <form id="microWordForm"
          th:action="@{/microword/save}"
          th:method="'post'">
        <textarea name="content" id="microWordContent"></textarea>
        <table>
            <tr>
                <td th:id="'uploadfile1'">
                    <button type="button"
                            onclick="clearImg(this);"
                            th:text="'Clear'"></button>
                    <input type="file"
                           th:name="'pictures'"
                           accept=".png,.jpg,.jpeg"
                           onchange="uploadPicture(this);"/>
                </td>
                <td th:id="'uploadfile2'">
                    <button type="button"
                            onclick="clearImg(this);"
                            th:text="'Clear'"></button>
                    <input type="file"
                           th:name="'pictures'"
                           accept=".png,.jpg,.jpeg"
                           onchange="uploadPicture(this);"/>
                </td>
                <td th:id="'uploadfile3'">
                    <button type="button"
                            onclick="clearImg(this);"
                            th:text="'Clear'"></button>
                    <input type="file"
                           th:name="'pictures'"
                           accept=".png,.jpg,.jpeg"
                           onchange="uploadPicture(this);"/>
                </td>
                <td th:id="'uploadfile4'">
                    <button type="button"
                            onclick="clearImg(this);"
                            th:text="'Clear'"></button>
                    <input type="file"
                           th:name="'pictures'"
                           accept=".png,.jpg,.jpeg"
                           onchange="uploadPicture(this);"/>
                </td>
                <td>
                    <button type="button"
                            id="btnsendmicroword"
                            th:text="OK"
                            th:onclick="'submitMicroWordForm();'">
                    </button>
                </td>
            </tr>
            <tr>
                <td id="uploadfile1_img"></td>
                <td id="uploadfile2_img"></td>
                <td id="uploadfile3_img"></td>
                <td id="uploadfile4_img"></td>
            </tr>
        </table>
    </form>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#microWordContent').emojioneArea({
                placeholder: '输入微说内容(图片上传不能超过5M/张)',
                buttonTitle: '按TAB键选择表情',
                pickerPosition: 'bottom',
                saveEmojisAs: 'shortname',
                recentEmojis: false,
                autocomplete: false,
                filtersPosition: 'bottom',
                tonesStyle: 'square'
            });
        })
    </script>
</div>

<div>
    <form action="#" th:action="@{/search}" th:method="get">
        <label th:text="'Search Content :'"></label>
        <input type="text" name="searchContent"/>
        <select th:name="'searchItem'">
            <option th:text="'MicroWord'" th:value="'microWord'"></option>
            <option th:text="'Username'" th:value="'username'"></option>
        </select>
        <input th:type="hidden" th:name="sort" value=""/>
        <input type="submit" th:value="'Search'"/>
        <a href="#"
           th:href="|${#request.requestURI}?${#strings.defaultString(#strings.substringBefore(#request.queryString,'&sort='),'')}&sort=createTime,asc&page=|"
           th:text="|CreateTime ASC|"></a>
        <a href="#"
           th:href="|${#request.requestURI}?${#strings.defaultString(#strings.substringBefore(#request.queryString,'&sort='),'')}&sort=createTime,desc&page=|"
           th:text="|CreateTime DESC|"></a>
    </form>
</div>

<br/>

<form th:action="@{/}" th:method="post" th:id="'microWordsForm'" th:unless="${microWords==null}">
    <div sec:authorize="hasAnyRole('ROLE_ADMIN_MICROWORD')">
        <input th:type="'button'" th:onclick="'selectAllCheck(\'microWordIds\',\'true\');'"
               th:value="'SelectAll'"/>
        <input th:type="'button'" th:onclick="'reserveAllCheck(\'microWordIds\');'" th:value="'ReserveAll'"/>
        <input th:type="'button'" th:onclick="'selectAllCheck(\'microWordIds\',\'false\');'"
               th:value="'UnSelectAll'"/>
        <input th:type="'button'" th:onclick="'deleteMicroWords();'" th:value="'Delete'"/>
    </div>
    <div th:each="microWord:${microWords}" style="border: dashed">
        <input type="checkbox" name="microWordIds" th:value="${microWord.id}"
               sec:authorize="hasAnyRole('ROLE_ADMIN_MICROWORD')"/>
        <img src=""
             th:src="@{/{profilePhoto}(profilePhoto=${microWord.user.userProfile.profilePhoto})}"
             th:width="32px"
             th:height="32px"/>
        <a th:text="${microWord.user.username}"
           th:href="@{/userprofile/details/{username}(username=${microWord.user.username})}"></a>
        <span th:text="${#dates.format(microWord.createTime,'yy-MM-dd HH:mm:ss')}"></span>
        <a href="#" th:href="@{/microword/details/{microWordId}(microWordId=${microWord.id})}" th:text="'View'">View</a>
        <input th:type="button"
               sec:authorize="hasAnyRole('ROLE_ADMIN_MICROWORD') or #authentication.name == #vars.microWord.user.username"
               th:onclick="|deleteMicroWord(${microWord.id})|"
               th:value="'Delete'"/>
        <p class="convert-emoji" th:utext="${microWord.content}"></p>
        <a th:each="microWordAttachment:${microWord.microWordAttachments}"
           th:href="@{/{pictureUrl}(pictureUrl=${microWordAttachment.url})}">
            <img src=""
                 width="128px"
                 height="128px"
                 th:src="@{/{pictureUrl}(pictureUrl=${microWordAttachment.url})}"/>
        </a>
        <br/>
        <span th:text="|Comment:${#lists.size(microWord.microWordComments)}|"></span>
        <span th:text="' | Agree:'"></span>
        <input type="button" th:id="|microWordId_agree_${microWord.id}|"
               th:onclick="|agreeMicroWord(${microWord.id})|"
               th:value="${#lists.size(microWord.microWordAgrees)}"/>
    </div>
</form>

<div th:if="${#bools.isTrue(isSearchMicroWordsResult)}">
    <div th:replace="microword/search :: searchmicroWordpageform"></div>
</div>
<div th:if="${#bools.isFalse(isSearchMicroWordsResult)}">
    <form action="" th:action="@{/}" th:method="get" th:onsubmit="'return pageFormSubmit()'">
        <span th:text="|${microWords.number+1}/${microWords.totalPages}Pages|">总页数</span>
        <input type="number" id="input_page" th:min="1" th:max="${microWords.totalPages}"
               th:required="required"/>
        <input type="hidden" th:name="sort"
               th:value="${#uris.unescapePath(#strings.substringBefore(#strings.substringAfter(#request.queryString,'sort='),'&page='))}"/>
        <input type="hidden" id="submit_page" th:name="page"/>
        <input type="submit" th:value="Go">
    </form>
    <a th:unless="${microWords.number == 0}"
       th:href="|@{/?}${#strings.defaultString(#strings.substringBefore(#request.queryString,'&page='),'')}&page=${microWords.number-1}|"
       th:text="'Previous'">上一页</a>
    <a th:unless="${microWords.number+1==microWords.totalPages || microWords.totalElements==0}"
       th:href="|@{/?}${#strings.defaultString(#strings.substringBefore(#request.queryString,'&page='),'')}&page=${microWords.number+1}|"
       th:text="'Next'">下一页</a>
    <span th:text="|${microWords.numberOfElements}/${microWords.totalElements} Elements Count|">页面显示数据量</span>
</div>
<div th:replace="template::footer"></div>
</body>
</html>