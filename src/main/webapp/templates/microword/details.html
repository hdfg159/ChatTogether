<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>MicroWord Details</title>
    <th:block th:replace="template::editorAsset">
    </th:block>
    <script th:inline="javascript">
        function agreeMicroWordDetail(microWordId) {
            var btn_agree = $('#btnagree');
            $.post('[(@{/microwordagree/api/save})]', {
                'microWordId': microWordId, _csrf: [[${_csrf.token}]]
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                btn_agree.val(parseInt(btn_agree.val()) + 1);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.info('Request Error!' + errorThrown);
                alert('您已经点赞过!不能再操作哦~');
            });
        }

        function deleteMicroWordDetail(id) {
            $.post('[(@{/microword/api/delete})]', {
                'id': id, _csrf: [[${_csrf.token}]]
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(-1);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function deleteMicroWordComment(id) {
            $.post('[(@{/microwordcomment/api/delete})]', {
                'id': id, _csrf: [[${_csrf.token}]]
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(0);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function deleteMicroWordCommentReply(id) {
            $.post('[(@{/microwordcommentreply/api/delete})]', {
                'id': id, _csrf: [[${_csrf.token}]]
            }, function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(0);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function replyComment(microwordCommentId, repliedUserId, repliedUserName) {
            $('#replyArea').css('display', 'block');
            $('#microwordCommentId').val(microwordCommentId);
            $('#repliedUserId').val(repliedUserId);
            $(window).scrollTop($('#commentReplyForm').offset().top);
        }

        function submitReplyComment() {
            var commentReplyContent = $('#commentReplyContent');
            if (commentReplyContent.val().length >= 200) {
                alert('Data too long...');
                return;
            }
            commentReplyContent.val(tranferStringLine(commentReplyContent.val()));
            $.post('[(@{/microwordcommentreply/api/save})]', $('#commentReplyForm').serialize(), function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(0);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }

        function submitComment() {
            var commentContent = $('#commentContent');
            if (commentContent.val().length >= 200) {
                alert('Data too long...');
                return;
            }
            commentContent.val(tranferStringLine(commentContent.val()));
            $.post('[(@{/microwordcomment/api/save})]', $('#commentForm').serialize(), function () {
            }).done(function (data, textStatus, jqXHR) {
                history.go(0);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert('Request Error!' + errorThrown);
            });
        }
    </script>
</head>
<body>
<div th:replace="template::header"></div>
<h3>MicroWord Details</h3>
<span th:text="'User:'"></span>
<img src=""
     th:src="@{/{profilePhoto}(profilePhoto=${microWordDetailVO.microWord.user.userProfile.profilePhoto})}"
     th:width="32px"
     th:height="32px"/>
<span th:text="${microWordDetailVO.microWord.user.username}"></span>
<div th:text="'Date:'+${#dates.format(microWordDetailVO.microWord.createTime,'yyyy-MM-dd HH:mm:ss')}">
</div>
<div class="convert-emoji" th:utext="'Content:'+${microWordDetailVO.microWord.content}">微说内容</div>
<a th:each="microWordAttachment:${microWordDetailVO.microWord.microWordAttachments}"
   th:href="@{/{pictureUrl}(pictureUrl=${microWordAttachment.url})}">
    <img src=""
         width="128px"
         height="128px"
         th:src="@{/{pictureUrl}(pictureUrl=${microWordAttachment.url})}"/>
</a>
<br/>
<span th:text="'Agree:'"></span>
<input type="button"
       th:id="'btnagree'"
       th:value="${#lists.size(microWordDetailVO.microWord.microWordAgrees)}"
       th:onclick="'agreeMicroWordDetail('+${microWordDetailVO.microWord.id}+')'"/>
<input type="button"
       th:value="'Delete'"
       th:onclick="'deleteMicroWordDetail('+${microWordDetailVO.microWord.id}+')'"
       th:if="${#authentication.name == microWordDetailVO.microWord.user.username or #authorization.expression('hasRole(''ROLE_ADMIN_MICROWORD'') or hasRole(''ROLE_ADMIN'')')}"/>
<br/>

<div sec:authorize="isAuthenticated()">
    <form id="commentForm" th:action="@{/microwordcomment/api/save}" method="post">
        <input type="hidden" th:name="'microWordId'" th:value="${microWordDetailVO.microWord.id}"/>
        <textarea id="commentContent" th:name="'content'"></textarea>
    </form>
    <button th:type="button" th:text="'ok'" id="btnSendComment" th:onclick="'submitComment();'"></button>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#commentContent').emojioneArea({
                placeholder: '既然看了就回复一下嘛~',
                buttonTitle: '按TAB键选择表情',
                pickerPosition: 'buttom',
                saveEmojisAs: 'shortname',
                recentEmojis: false,
                autocomplete: false,
                tonesStyle: 'square'
            });
        })
    </script>
</div>
<br>

<div th:each="microWordComment:${microWordDetailVO.getMicroWordCommentPage()}" style="border: dashed">
    <img src=""
         th:src="@{/{profilePhoto}(profilePhoto=${microWordComment.commentUser.userProfile.profilePhoto})}"
         th:width="32px"
         th:height="32px"/>
    <a th:text="${microWordComment.commentUser.username}"
       th:href="@{/userprofile/details/{username}(username=${microWordComment.commentUser.username})}">
    </a>
    <span th:text="' Date:'+${#dates.format(microWordComment.createTime,'yy-MM-dd HH:mm:ss')}"></span>
    <input type="button" value="Delete"
           th:onclick="'deleteMicroWordComment('+${microWordComment.id}+')'"
           th:if="${#authentication.name == microWordComment.commentUser.username or #authorization.expression('hasAnyRole(''ROLE_ADMIN_COMMENT'')')}"/>
    <input type="button"
           value="Reply"
           sec:authorize="isAuthenticated()"
           th:onclick="'replyComment('+${microWordComment.id}+','+${microWordComment.commentUser.id}+','+'\''+${microWordComment.commentUser.username}+'\''+')'"/>
    <p class="convert-emoji" th:utext="${microWordComment.content}"></p>
    <ul>
        <li th:each="microWordCommentReply:${microWordComment.getMicroWordCommentReplies()}">
            <img src=""
                 th:src="@{/{profilePhoto}(profilePhoto=${microWordCommentReply.repliedUser.userProfile.profilePhoto})}"
                 th:width="32px"
                 th:height="32px"/>
            <a th:href="@{/userprofile/details/{username}(username=${microWordComment.commentUser.username})}"
               th:text="${microWordCommentReply.repliedUser.username}"></a>
            <span th:text="' To '"></span>
            <img src=""
                 th:src="@{/{profilePhoto}(profilePhoto=${microWordCommentReply.replyUser.userProfile.profilePhoto})}"
                 th:width="32px"
                 th:height="32px"/>
            <a th:href="@{/userprofile/details/{username}(username=${microWordComment.commentUser.username})}"
               th:text="${microWordCommentReply.replyUser.username}"></a>
            <span th:text="' Date:'+${#dates.format(microWordCommentReply.createTime,'yy-MM-dd HH:mm:ss')}"></span>
            <input type="button"
                   value="Delete"
                   th:if="${#authentication.name == microWordCommentReply.replyUser.username or #authorization.expression('hasAnyRole(''ROLE_ADMIN_COMMENT'')')}"
                   th:onclick="'deleteMicroWordCommentReply('+${microWordCommentReply.id}+')'"/>
            <input type="button"
                   sec:authorize="isAuthenticated()"
                   value="Reply"
                   th:onclick="'replyComment('+${microWordComment.id}+','+${microWordCommentReply.replyUser.id}+','+'\''+${microWordCommentReply.replyUser.username}+'\''+')'"/>
            <p class="convert-emoji"
               th:utext="${microWordCommentReply.content}">
            </p>
        </li>
    </ul>
</div>

<div sec:authorize="isAuthenticated()" style="display: none;" id="replyArea">
    <br/>
    <form id="commentReplyForm" th:action="@{/microwordcommentreply/api}" method="post">
        <input type="hidden" th:name="'microWordId'" th:value="${microWordDetailVO.microWord.id}"/>
        <input type="hidden" th:name="'microwordCommentId'" id="microwordCommentId"/>
        <input type="hidden" th:name="'repliedUserId'" id="repliedUserId">
        <textarea id="commentReplyContent" th:name="'content'"></textarea>
    </form>
    <button th:type="button" th:text="'ok'" id="btnSendCommentReply" th:onclick="'submitReplyComment();'"></button>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#commentReplyContent').emojioneArea({
                placeholder: '回复:',
                buttonTitle: '按TAB键选择表情',
                pickerPosition: 'top',
                saveEmojisAs: 'shortname',
                recentEmojis: false,
                autocomplete: false,
                tonesStyle: 'square'
            });
        })
    </script>
</div>

<div>
    <form th:action="@{/microword/details/{microWordId}(microWordId=${microWordDetailVO.microWord.id})}"
          th:method="get" th:onsubmit="'return pageFormSubmit()'">
        <span th:text=" ${microWordDetailVO.microWordCommentPage.number+1}
        ">页</span>
        <span th:text="'/'">/</span>
        <span th:text="${microWordDetailVO.microWordCommentPage.totalPages}+' Pages'">总页数</span>
        <input type="number" th:min="1" th:max="${microWordDetailVO.microWordCommentPage.totalPages}" th:id="input_page"
               th:required="required"/>
        <input type="hidden" th:name="page" th:id="submit_page"/>
        <input type="submit" th:value="Go">
    </form>
    <a th:unless="${microWordDetailVO.microWordCommentPage.number==0}"
       th:href="@{/microword/details/{microWordId}(microWordId=${microWordDetailVO.microWord.id},page=${microWordDetailVO.microWordCommentPage.number - 1})}"
       th:text="'Previous'">上一页</a>
    <a th:unless="${microWordDetailVO.microWordCommentPage.number + 1== microWordDetailVO.microWordCommentPage.totalPages}"
       th:href="@{/microword/details/{microWordId}(microWordId=${microWordDetailVO.microWord.id},page=${microWordDetailVO.microWordCommentPage.number+1})}"
       th:text="'Next'">下一页</a>
    <span th:text="'Page Displays Elements Count:'+${microWordDetailVO.microWordCommentPage.numberOfElements}+'/'">页面显示数据量</span>
    <span th:text="'All Elements Count:'+${microWordDetailVO.microWordCommentPage.totalElements}">总数据量</span>
</div>
<div th:replace="template::footer"></div>
</body>
</html>